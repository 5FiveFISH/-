drop table if exists tmp_cwq_indicators_weekly_ordertype;
create table tmp_cwq_indicators_weekly_ordertype as 
select 
     week
    ,type
    ,order_type
    ,task_num                                                                               -- 任务量
    ,answer_num                                                                             -- 接通
    ,hit_num                                                                                -- 命中

    ,order_num                                                                              -- 订单
    ,round(order_num*100.0/task_num, 2) order_conversion_rate                               -- 订单转化率
    ,answer_order                                                                           -- 接通订单
    ,no_answer_order                                                                        -- 未接通订单
    ,hit_order                                                                              -- 命中订单
    ,no_hit_order                                                                           -- 非命中订单
    ,round(answer_order*100.0/answer_num, 2) answer_order_rate                              -- 接通订单率
    ,round(no_answer_order*100.0/no_answer_num, 2) no_answer_order_rate                     -- 未接通订单率
    ,round(hit_order*100.0/hit_num, 2) hit_order_rate                                       -- 命中订单率
    ,round(no_hit_order*100.0/no_hit_num, 2) no_hit_order_rate                              -- 非命中订单率

    ,vocation_order                                                                         -- 度假
    ,answer_vocation_order                                                                  -- 接通度假
    ,no_answer_vocation_order                                                               -- 非接通度假
    ,hit_vocation_order                                                                     -- 命中度假
    ,no_hit_vocation_order                                                                  -- 非命中度假
    ,round(answer_vocation_order*100.0/answer_num, 2) answer_vocation_order_rate            -- 接通度假率
    ,round(no_answer_vocation_order*100.0/no_answer_num, 2) no_answer_vocation_order_rate   -- 未接通度假率
    ,round(hit_vocation_order*100.0/hit_num, 2) hit_vocation_order_rate                     -- 命中度假率
    ,round(no_hit_vocation_order*100.0/no_hit_num, 2) no_hit_vocation_order_rate            -- 非命中度假率
from (
    select
         weekofyear(date_add(from_unixtime(unix_timestamp(dt, 'yyyyMMdd')),1)) week
        ,type
        ,case when create_saler_id in (0, 39) then 1 else 0 end order_type
        ,count(distinct cust_id) task_num 
        ,count(distinct case when answer_flag=1 then cust_id else null end) answer_num 
        ,count(distinct case when answer_flag=0 then cust_id else null end) no_answer_num 
        ,count(distinct case when answer_flag=1 and label ='1' then cust_id else null end) hit_num 
        ,count(distinct case when answer_flag=1 and label<>'1' then cust_id else null end) no_hit_num 

        ,count(distinct case when                   order_mark_14=1 then order_id else null end) order_num 
        ,count(distinct case when answer_flag=1 and order_mark_14=1 then order_id else null end) answer_order 
        ,count(distinct case when answer_flag=0 and order_mark_14=1 then order_id else null end) no_answer_order 
        ,count(distinct case when answer_flag=1 and label  = '1' and order_mark_14=1 then order_id else null end) hit_order 
        ,count(distinct case when answer_flag=1 and label <> '1' and order_mark_14=1 then order_id else null end) no_hit_order 

        ,count(distinct case when                   order_mark_14=1 and vocation_mark=1 then order_id else null end) vocation_order 
        ,count(distinct case when answer_flag=1 and order_mark_14=1 and vocation_mark=1 then order_id else null end) answer_vocation_order 
        ,count(distinct case when answer_flag=0 and order_mark_14=1 and vocation_mark=1 then order_id else null end) no_answer_vocation_order 
        ,count(distinct case when answer_flag=1 and label  = '1' and order_mark_14=1 and vocation_mark=1 then order_id else null end) hit_vocation_order 
        ,count(distinct case when answer_flag=1 and label <> '1' and order_mark_14=1 and vocation_mark=1 then order_id else null end) no_hit_vocation_order 
    from dw.ol_dm_destination_predict_effect
    where dt>='20230101'
    group by 
        weekofyear(date_add(from_unixtime(unix_timestamp(dt, 'yyyyMMdd')),1))
        ,type
        ,case when create_saler_id in (0, 39) then 1 else 0 end
) a 
order by week, type, order_type
limit 1000;
